pipeline {
    agent { label 'cd_development' }

    environment {
        PROJECT_NAME = "documenso"
        REPO_URL = "https://github.com/Caring-data/documenso"
        CONTAINER_NAME = "documenso_container"
        NGINX_CONTAINER_NAME = "nginx_documento_next"
        BLUE_CONTAINER = "documenso_blue"
        GREEN_CONTAINER = "documenso_green"
        HEALTH_CHECK_INTERVAL = "15"
        MAX_HEALTH_ATTEMPTS = "30"
        WARM_UP_TIME = "30"
    }

    stages {
        stage('Prepare Workspace') {
            steps {
                script {
                    sh 'whoami'
                    echo "üöÄ Starting deployment to development environment"
                }
            }
        }
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/staging']],
                          userRemoteConfigs: [[
                              url: "${REPO_URL}",
                              credentialsId: 'git_credentials'
                          ]]])
            }
        }
        stage('Copy .env') {
            steps {
                script {
                    sh """
                        if [ -f "${JENKINS_HOME}/workspace/documenso_development/.env" ]; then
                            sudo rm -f ${JENKINS_HOME}/workspace/documenso_development/.env
                        fi
                    """
                    sh 'sudo cp /home/caringdata/development/documenso/.env ${JENKINS_HOME}/workspace/documenso_development/.env'
                    echo "‚úÖ Environment file copied successfully"
                }
            }
        }
        stage('Build and Deploy with Blue-Green') {
            steps {
                script {
                    sh 'cd ${JENKINS_HOME}/workspace/documenso_development'

                    // Build the Docker images for blue and green environments
                    sh "docker compose build ${BLUE_CONTAINER} ${GREEN_CONTAINER}"

                    def activeContainer = sh(
                        script: "grep -oP 'server \\K(${BLUE_CONTAINER}|${GREEN_CONTAINER})' docker/nginx/default.conf | head -1 || echo '${BLUE_CONTAINER}'", 
                        returnStdout: true
                    ).trim()

                    // If no active container found, default to blue
                    if (activeContainer == '') {
                        activeContainer = BLUE_CONTAINER
                    }

                    def newContainer = (activeContainer == BLUE_CONTAINER) ? GREEN_CONTAINER : BLUE_CONTAINER

                    echo "Active container: ${activeContainer}"
                    echo "Deploying to: ${newContainer}"

                    // Deploy the new container
                    sh "docker compose up -d --no-deps ${newContainer}"
                    echo "üöÄ Deploying to **${newContainer == BLUE_CONTAINER ? 'BLUE üîµ' : 'GREEN üü¢'}** environment! üöÄ"

                    // Wait until the new container is healthy
                    waitForHealth(newContainer)

                    echo "‚è≥ Waiting ${WARM_UP_TIME} seconds for application warm-up..."
                    sh "sleep ${WARM_UP_TIME}"

                    verifyContainerReadiness(newContainer)

                    // Update Nginx configuration to use the new container
                    sh "sed -i 's/${activeContainer}/${newContainer}/g' docker/nginx/default.conf"
                    sh "docker compose up -d --no-deps ${NGINX_CONTAINER_NAME}"

                    // Wait a bit for nginx to reload
                    echo "‚è≥ Waiting for nginx to reload configuration..."
                    sh "sleep 10"

                    verifyNginxHealth()

                    // Stop the previous container
                    sh "docker compose stop ${activeContainer} || true"

                    // Remove the previous container
                    sh "docker compose rm -f ${activeContainer} || true"

                    // Delete containers and images not used
                    sh "docker system prune -f --volumes"

                    echo "‚úÖ Blue-Green deployment completed successfully to ${newContainer} in development environment!"
                }
            }
        }
    }
}

def waitForHealth(container) {
    sh """
    attempt=1
    max_attempts=\${MAX_HEALTH_ATTEMPTS}
    interval=\${HEALTH_CHECK_INTERVAL}

    echo "üîç Checking health of ${container}..."
    echo "Max attempts: \$max_attempts, Interval: \$interval seconds"

    while [ \$attempt -le \$max_attempts ]; do
         if docker inspect --format='{{.State.Health.Status}}' \${WORKSPACE##*/}_${container}_1 2>/dev/null | grep -q healthy; then
            echo "‚úÖ ${container} is healthy (format 1)"
            break
        elif docker inspect --format='{{.State.Health.Status}}' ${container} 2>/dev/null | grep -q healthy; then
            echo "‚úÖ ${container} is healthy (format 2)"
            break
        elif docker inspect --format='{{.State.Health.Status}}' documenso_development_${container}_1 2>/dev/null | grep -q healthy; then
            echo "‚úÖ ${container} is healthy (format 3)"
            break
        fi

         current_status=\$(docker inspect --format='{{.State.Health.Status}}' \${WORKSPACE##*/}_${container}_1 2>/dev/null || echo "unknown")
        echo "‚è≥ Waiting for ${container} to be healthy (attempt \$attempt/\$max_attempts) - Current status: \$current_status"

        sleep \$interval
        attempt=\$((attempt + 1))
    done

    if [ \$attempt -gt \$max_attempts ]; then
        echo "‚ùå ${container} did not become healthy in time"
        echo "üîç Container logs for debugging:"
        docker logs ${container} --tail 50 || docker logs \${WORKSPACE##*/}_${container}_1 --tail 50 || true
        exit 1
    fi
    """
}